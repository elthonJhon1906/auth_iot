<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Super Admin Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(135deg, #003366, #0055a5);
      margin: 0; padding: 0; color: #fff;
    }

    /* Navbar */
    .navbar {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(0,0,0,0.4); padding: 15px 30px; backdrop-filter: blur(6px);
    }
    .navbar h2 { margin: 0; color: #e6f0ff; }
    .navbar button { margin-left: 10px; padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; }

    .btn-logout { background: #ff4d4d; color: #fff; }
    .btn-logout:hover { background: #cc0000; }

    .btn-manage {
      background: linear-gradient(135deg, #00bfff, #0077b6);
      color: #fff; border: none; border-radius: 8px;
      padding: 10px 18px; font-weight: bold; cursor: pointer;
      transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0,191,255,0.4);
    }
    .btn-manage:hover {
      background: linear-gradient(135deg, #0077b6, #00bfff);
      transform: scale(1.05); box-shadow: 0 6px 20px rgba(0,191,255,0.6);
    }
    .btn-manage:active { transform: scale(0.98); box-shadow: 0 3px 10px rgba(0,191,255,0.4); }

    /* Dashboard */
    .container { display: flex; justify-content: space-around; align-items: flex-start; flex-wrap: wrap; padding: 30px; }
    .chart-box { width: 45%; background: rgba(255,255,255,0.1); backdrop-filter: blur(6px); border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
    .chart-box-full { width: 90%; text-align: center; margin-top: 20px; }
    canvas { margin-top: 15px; }
    .tv-buttons button { margin: 0 10px; }
  </style>
</head>
<body>
<script>
  // Proteksi akses super_admin
  const token = localStorage.getItem("token");
  const role = localStorage.getItem("role");
  if (!token || role !== "super_admin") {
    alert("Akses ditolak! Hanya Super Admin.");
    window.location.href = "login.html";
  }
</script>

<!-- Navbar -->
<div class="navbar">
  <h2>Super Admin Dashboard</h2>
  <div>
    <button class="btn-manage" onclick="goToUserManagement()">Management User</button>
    <button class="btn-logout" onclick="logout()">Logout</button>
  </div>
</div>

<!-- Dashboard -->
<div class="container">
  <div class="chart-box">
    <h3>Data Jarak 1</h3>
    <canvas id="chartJarak1" height="120"></canvas>
  </div>
  <div class="chart-box">
    <h3>Data Jarak 2</h3>
    <canvas id="chartJarak2" height="120"></canvas>
  </div>

  <div class="chart-box chart-box-full">
    <h3>Kontrol TV</h3>
    <p>Status: <span id="tvStatus">Loading...</span></p>
    <div class="tv-buttons">
      <button class="btn-manage" onclick="setTV(1)">Hidupkan TV</button>
      <button class="btn-manage" onclick="setTV(0)">Matikan TV</button>
    </div>
  </div>
</div>

<script>
  function logout() {
    localStorage.removeItem("token");
    localStorage.removeItem("role");
    window.location.href = "login.html";
  }
  function goToUserManagement() {
    window.location.href = "user_management.html";
  }

  // Chart Jarak
  async function fetchData(endpoint, chartId) {
    try {
      const res = await fetch(`http://localhost:3000/api/${endpoint}`, { headers: { "Authorization": `Bearer ${token}` } });
      const data = await res.json();
      if (!res.ok) { console.error(data.message || "Gagal fetch"); return; }
      renderChart(data, chartId);
    } catch (err) { console.error(err); }
  }

  function renderChart(data, chartId) {
    const labels = data.map(d => new Date(d.created_at).toLocaleString());
    const jarak = data.map(d => d.jarak);
    const status = data.map(d => d.status);
    const statusColors = status.map(s => s==="JAUH"? "red" : s==="SEDANG"? "yellow" : "green");

    const ctx = document.getElementById(chartId).getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: { labels, datasets: [{ label:'Jarak (cm)', data: jarak, borderColor:'#00bfff', tension:0.3, fill:false, pointRadius:6, pointBackgroundColor:statusColors }] },
      options: { responsive:true, plugins:{ legend:{display:true}, tooltip:{ callbacks:{ label: function(ctx){ const i=ctx.dataIndex; return `Jarak: ${jarak[i]} cm (${status[i]})`; } } } }, scales:{ y:{beginAtZero:true, title:{display:true,text:"Jarak (cm)"}}, x:{title:{display:true,text:"Waktu"}} } }
    });
  }

  fetchData("distance_1","chartJarak1");
  fetchData("distance_2","chartJarak2");

  // Kontrol TV
  async function getTVStatus() {
    try {
      const res = await fetch("http://localhost:3000/api/controller", { headers: { "Authorization": `Bearer ${token}` } });
      const data = await res.json();
      const status = data.tv_status;
      document.getElementById("tvStatus").innerText = status===1 ? "Hidup" : "Mati";
    } catch (err) { console.error(err); document.getElementById("tvStatus").innerText="Error"; }
  }

  async function setTV(value) {
    try {
      const res = await fetch("http://localhost:3000/api/controller", {
        method:"POST",
        headers:{ "Content-Type":"application/json", "Authorization": `Bearer ${token}` },
        body: JSON.stringify({ tv_status: value })
      });
      if (res.ok) getTVStatus();
    } catch(err){ console.error(err); }
  }

  getTVStatus();
</script>
</body>
</html>
